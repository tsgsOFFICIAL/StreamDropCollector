using System.Diagnostics;
using System.Text.Json;
using Core.Interfaces;
using Core.Models;
using Core.Enums;

namespace Core.Services
{
    /// <summary>
    /// Provides an implementation of a drops campaign provider for the Kick platform.
    /// </summary>
    /// <remarks>Use this class to retrieve active drops campaigns available on Kick. Inherits common
    /// functionality from DropsCampaignProviderBase and specializes it for the Kick platform.</remarks>
    public class KickDropsProvider : DropsCampaignProviderBase
    {
        /// <summary>
        /// Gets the streaming platform associated with this instance.
        /// </summary>
        public override Platform Platform => Platform.Kick;
        /// <summary>
        /// Asynchronously retrieves a list of currently active Drops campaigns from the Kick platform.
        /// </summary>
        /// <remarks>This method navigates the provided web view host to the Kick Drops campaigns page and
        /// extracts campaign data by executing JavaScript. Only campaigns with a status of "active" are included in the
        /// result.</remarks>
        /// <param name="host">The web view host used to navigate and execute scripts against the Kick Drops campaigns page. Must be
        /// initialized before calling this method.</param>
        /// <param name="ct">A cancellation token that can be used to cancel the asynchronous operation.</param>
        /// <returns>A read-only list of active Drops campaigns. Returns an empty list if no active campaigns are found.</returns>
        public override async Task<IReadOnlyList<DropsCampaign>> GetActiveCampaignsAsync(IWebViewHost host, CancellationToken ct = default)
        {
            await host.EnsureInitializedAsync();
            await host.NavigateAsync("https://web.kick.com/api/v1/drops/campaigns");

            string rawJson = await host.ExecuteScriptAsync("document.body.innerText");
            //string json = rawJson.Trim('"').Replace("\\n", "").Replace("\\\"", "\"");
            string json = "{\"data\":[{\"category\":{\"id\":13,\"image_url\":\"https://files.kick.com/images/subcategories/13/banner/77786fd4-4f33-4221-b8ee-2bf3cb4d041e\",\"name\":\"Rust\",\"slug\":\"rust\"},\"channels\":[],\"connect_url\":\"https://kick.facepunch.com\",\"created_at\":\"2025-10-31T12:44:44.693257Z\",\"ends_at\":\"2025-11-23T23:59:00Z\",\"id\":\"01K8X4S18DE0JMXSX8A5WWNS0N\",\"name\":\"Rust Kick Off General Drops\",\"organization\":{\"id\":\"01K6WKP5BBMPZJ89G5Y7QK1E9P\",\"name\":\"Facepunch Studios\",\"url\":\"https://kick.facepunch.com\"},\"rewards\":[{\"category_id\":13,\"id\":\"01K8X31CKQSSSFVJG7XMB8PTVS\",\"image_url\":\"drops/reward-image/01k8x31ckqsssfvjg7xmb8ptvs.png\",\"name\":\"KICK Rock\",\"organization_id\":\"01K6WKP5BBMPZJ89G5Y7QK1E9P\",\"required_units\":120},{\"category_id\":13,\"id\":\"01K8X32X3YS1RSEK28D0GTPS4G\",\"image_url\":\"drops/reward-image/01k8x32x3ys1rsek28d0gtps4g.png\",\"name\":\"KICK Furnace\",\"organization_id\":\"01K6WKP5BBMPZJ89G5Y7QK1E9P\",\"required_units\":240},{\"category_id\":13,\"id\":\"01K8X340VJBXXCYP7VT336C6YK\",\"image_url\":\"drops/reward-image/01k8x340vjbxxcyp7vt336c6yk.png\",\"name\":\"KICK Door\",\"organization_id\":\"01K6WKP5BBMPZJ89G5Y7QK1E9P\",\"required_units\":360},{\"category_id\":13,\"id\":\"01K8X37R19WHHSG8EKC1WG4K13\",\"image_url\":\"drops/reward-image/01k8x37r19whhsg8ekc1wg4k13.png\",\"name\":\"KICK Hazmat\",\"organization_id\":\"01K6WKP5BBMPZJ89G5Y7QK1E9P\",\"required_units\":480}],\"rule\":{\"id\":1,\"name\":\"Watch to redeem\"},\"starts_at\":\"2025-11-13T21:00:00Z\",\"status\":\"active\",\"updated_at\":\"2025-11-01T12:43:55.012406Z\",\"url\":\"https://kick.facepunch.com\"},{\"category\":{\"id\":13,\"image_url\":\"https://files.kick.com/images/subcategories/13/banner/77786fd4-4f33-4221-b8ee-2bf3cb4d041e\",\"name\":\"Rust\",\"slug\":\"rust\"},\"channels\":[{\"banner_picture_url\":\"https://files.kick.com/images/channel/1661881/banner_image/default-banner-2.jpg\",\"description\":\"\",\"id\":1661881,\"slug\":\"ricoy\",\"user\":{\"id\":1711034,\"profile_picture\":\"https://files.kick.com/images/user/1711034/profile_image/conversion/101aa7a7-6f75-43d2-a0d3-8fde7aa7f664-fullsize.webp\",\"username\":\"Ricoy\"}},{\"banner_picture_url\":\"https://files.kick.com/images/channel/969446/banner_image/default-banner-2.jpg\",\"description\":\"\",\"id\":969446,\"slug\":\"dilanzito\",\"user\":{\"id\":1011977,\"profile_picture\":\"https://files.kick.com/images/user/1011977/profile_image/conversion/32a59b29-c319-4210-b5a0-ac14dd112f13-fullsize.webp\",\"username\":\"dilanzito\"}}],\"connect_url\":\"https://kick.facepunch.com\",\"created_at\":\"2025-10-31T12:46:39.78377Z\",\"ends_at\":\"2025-11-23T23:59:00Z\",\"id\":\"01K8X4WHMVTF4HQNT9RRTGBACK\",\"name\":\"Team Ricoy MP5\",\"organization\":{\"id\":\"01K6WKP5BBMPZJ89G5Y7QK1E9P\",\"name\":\"Facepunch Studios\",\"url\":\"https://kick.facepunch.com\"},\"rewards\":[{\"category_id\":13,\"id\":\"01K8X3P1D3AE2PNEBP1VJCVXAR\",\"image_url\":\"drops/reward-image/01k8x3p1d3ae2pnebp1vjcvxar.png\",\"name\":\"Team Ricoy MP5\",\"organization_id\":\"01K6WKP5BBMPZJ89G5Y7QK1E9P\",\"required_units\":120}],\"rule\":{\"id\":1,\"name\":\"Watch to redeem\"},\"starts_at\":\"2025-11-13T21:00:00Z\",\"status\":\"active\",\"updated_at\":\"2025-11-05T20:42:33.761611Z\",\"url\":\"https://kick.facepunch.com\"},{\"category\":{\"id\":13,\"image_url\":\"https://files.kick.com/images/subcategories/13/banner/77786fd4-4f33-4221-b8ee-2bf3cb4d041e\",\"name\":\"Rust\",\"slug\":\"rust\"},\"channels\":[{\"banner_picture_url\":\"https://files.kick.com/images/channel/715/banner_image/091d48ae-bf63-4605-807d-8fc64435cf00\",\"description\":\"squadW - #1 Podcast\",\"id\":715,\"slug\":\"trainwreckstv\",\"user\":{\"id\":723,\"profile_picture\":\"https://files.kick.com/images/user/723/profile_image/conversion/87a305ea-3bc8-4e65-8772-9a453e8b9f37-fullsize.webp\",\"username\":\"Trainwreckstv\"}},{\"banner_picture_url\":\"https://files.kick.com/images/channel/991504/banner_image/default-banner-2.jpg\",\"description\":\"\",\"id\":991504,\"slug\":\"lifestomper\",\"user\":{\"id\":1035246,\"profile_picture\":\"https://files.kick.com/images/user/1035246/profile_image/conversion/26469f22-e7eb-4354-b23d-58956e9b901a-medium.webp\",\"username\":\"Lifestomper\"}},{\"banner_picture_url\":\"https://files.kick.com/images/channel/116770/banner_image/default-banner-2.jpg\",\"description\":\"Absolute freakazoid. At your service.\",\"id\":116770,\"slug\":\"templetaps\",\"user\":{\"id\":118094,\"profile_picture\":\"https://files.kick.com/images/user/118094/profile_image/conversion/805cb0e6-55f7-4d67-a72f-c32d8a065af2-fullsize.webp\",\"username\":\"Templetaps\"}},{\"banner_picture_url\":\"https://files.kick.com/images/channel/127569/banner_image/623218ce-8e96-4827-98e9-1c64de18db64\",\"description\":\"xD !!!!!\",\"id\":127569,\"slug\":\"posty\",\"user\":{\"id\":128995,\"profile_picture\":\"https://files.kick.com/images/user/128995/profile_image/conversion/3cddbbe3-df1a-49a5-ae27-932863462602-fullsize.webp\",\"username\":\"Posty\"}}],\"connect_url\":\"https://kick.facepunch.com\",\"created_at\":\"2025-10-31T13:56:24.972512Z\",\"ends_at\":\"2025-11-23T23:59:00Z\",\"id\":\"01K8X8W8PH27GTBGP4EF2CAMRW\",\"name\":\"Team Trainwreckstv L96\",\"organization\":{\"id\":\"01K6WKP5BBMPZJ89G5Y7QK1E9P\",\"name\":\"Facepunch Studios\",\"url\":\"https://kick.facepunch.com\"},\"rewards\":[{\"category_id\":13,\"id\":\"01K8X3QPGA4Q0TMZ4DH9AWCAG9\",\"image_url\":\"drops/reward-image/01k8x3qpga4q0tmz4dh9awcag9.png\",\"name\":\"Team Trainwreckstv L96\",\"organization_id\":\"01K6WKP5BBMPZJ89G5Y7QK1E9P\",\"required_units\":120}],\"rule\":{\"id\":1,\"name\":\"Watch to redeem\"},\"starts_at\":\"2025-11-13T21:00:00Z\",\"status\":\"active\",\"updated_at\":\"2025-11-11T20:37:17.493821Z\",\"url\":\"https://kick.facepunch.com\"},{\"category\":{\"id\":13,\"image_url\":\"https://files.kick.com/images/subcategories/13/banner/77786fd4-4f33-4221-b8ee-2bf3cb4d041e\",\"name\":\"Rust\",\"slug\":\"rust\"},\"channels\":[{\"banner_picture_url\":\"https://files.kick.com/images/channel/2492099/banner_image/default-banner-2.jpg\",\"description\":\"\",\"id\":2492099,\"slug\":\"serwinter\",\"user\":{\"id\":2547151,\"profile_picture\":\"https://files.kick.com/images/user/2547151/profile_image/conversion/c5945ee0-99ff-4473-8069-c88db606076f-medium.webp\",\"username\":\"SerWinter\"}},{\"banner_picture_url\":\"https://files.kick.com/images/channel/1633571/banner_image/default-banner-2.jpg\",\"description\":\"\",\"id\":1633571,\"slug\":\"omni\",\"user\":{\"id\":1682397,\"profile_picture\":\"https://files.kick.com/images/user/1682397/profile_image/conversion/22c1b5ec-af86-456f-b13a-093a7bedac7f-medium.webp\",\"username\":\"Omni\"}}],\"connect_url\":\"https://kick.facepunch.com\",\"created_at\":\"2025-10-31T13:58:12.442198Z\",\"ends_at\":\"2025-11-23T23:59:00Z\",\"id\":\"01K8X8ZHN45KG5PW7T2VA3C8WR\",\"name\":\"Team Ser Winter Thompson\",\"organization\":{\"id\":\"01K6WKP5BBMPZJ89G5Y7QK1E9P\",\"name\":\"Facepunch Studios\",\"url\":\"https://kick.facepunch.com\"},\"rewards\":[{\"category_id\":13,\"id\":\"01K8X3T8Q3Z942YKJF6T42BYJX\",\"image_url\":\"drops/reward-image/01k8x3t8q3z942ykjf6t42byjx.png\",\"name\":\"Team Ser Winter Thompson\",\"organization_id\":\"01K6WKP5BBMPZJ89G5Y7QK1E9P\",\"required_units\":120}],\"rule\":{\"id\":1,\"name\":\"Watch to redeem\"},\"starts_at\":\"2025-11-13T21:00:00Z\",\"status\":\"active\",\"updated_at\":\"2025-11-07T21:38:50.030585Z\",\"url\":\"https://kick.facepunch.com\"},{\"category\":{\"id\":13,\"image_url\":\"https://files.kick.com/images/subcategories/13/banner/77786fd4-4f33-4221-b8ee-2bf3cb4d041e\",\"name\":\"Rust\",\"slug\":\"rust\"},\"channels\":[{\"banner_picture_url\":\"https://files.kick.com/images/channel/93788/banner_image/default-banner-1\",\"description\":\"soon\",\"id\":93788,\"slug\":\"winnie\",\"user\":{\"id\":94866,\"profile_picture\":\"https://files.kick.com/images/user/94866/profile_image/conversion/ba341bc6-9d70-4c0f-8bff-1e0937b4b453-fullsize.webp\",\"username\":\"winnie\"}},{\"banner_picture_url\":\"https://files.kick.com/images/channel/1727361/banner_image/default-banner-2.jpg\",\"description\":\"\",\"id\":1727361,\"slug\":\"coconutb\",\"user\":{\"id\":1777459,\"profile_picture\":\"https://files.kick.com/images/user/1777459/profile_image/conversion/4cf376fc-7fdf-45bf-a1a4-65a066e132d8-fullsize.webp\",\"username\":\"CoconutB\"}}],\"connect_url\":\"https://kick.facepunch.com\",\"created_at\":\"2025-10-31T13:59:44.508201Z\",\"ends_at\":\"2025-11-23T23:59:00Z\",\"id\":\"01K8X92BJ6X4KMVBVVPGHBG6DW\",\"name\":\"Team CoconutB Sleeping Bag\",\"organization\":{\"id\":\"01K6WKP5BBMPZJ89G5Y7QK1E9P\",\"name\":\"Facepunch Studios\",\"url\":\"https://kick.facepunch.com\"},\"rewards\":[{\"category_id\":13,\"id\":\"01K8X3Y1NNRT3JRT7PG38DQYR3\",\"image_url\":\"drops/reward-image/01k8x3y1nnrt3jrt7pg38dqyr3.png\",\"name\":\"Team CoconutB Sleeping Bag\",\"organization_id\":\"01K6WKP5BBMPZJ89G5Y7QK1E9P\",\"required_units\":120}],\"rule\":{\"id\":1,\"name\":\"Watch to redeem\"},\"starts_at\":\"2025-11-13T21:00:00Z\",\"status\":\"active\",\"updated_at\":\"2025-11-05T22:47:35.64519Z\",\"url\":\"https://kick.facepunch.com\"},{\"category\":{\"id\":13,\"image_url\":\"https://files.kick.com/images/subcategories/13/banner/77786fd4-4f33-4221-b8ee-2bf3cb4d041e\",\"name\":\"Rust\",\"slug\":\"rust\"},\"channels\":[{\"banner_picture_url\":\"https://files.kick.com/images/channel/61531/banner_image/b853b9a0-b56d-45ca-98ab-d15eb8692195\",\"description\":\"I love food and games, I mostly stream survival games but you might see me play something different.\",\"id\":61531,\"slug\":\"hutnik\",\"user\":{\"id\":62080,\"profile_picture\":\"https://files.kick.com/images/user/62080/profile_image/conversion/8b272e08-72b5-4ae8-873a-456d1b642769-fullsize.webp\",\"username\":\"Hutnik\"}},{\"banner_picture_url\":\"https://files.kick.com/images/channel/95355/banner_image/default-banner-2.jpg\",\"description\":\"\",\"id\":95355,\"slug\":\"hjune\",\"user\":{\"id\":96442,\"profile_picture\":\"https://files.kick.com/images/user/96442/profile_image/conversion/27eb39ed-e824-4a44-9819-64b0bd1f893f-medium.webp\",\"username\":\"hJune\"}}],\"connect_url\":\"https://kick.facepunch.com\",\"created_at\":\"2025-10-31T14:02:08.577979Z\",\"ends_at\":\"2025-11-23T23:59:00Z\",\"id\":\"01K8X96R8KR6VX1BFX6BSN1ZBY\",\"name\":\"Team hJune Jacket\",\"organization\":{\"id\":\"01K6WKP5BBMPZJ89G5Y7QK1E9P\",\"name\":\"Facepunch Studios\",\"url\":\"https://kick.facepunch.com\"},\"rewards\":[{\"category_id\":13,\"id\":\"01K8X4DZ25CZRY5HRTQA0NBP58\",\"image_url\":\"drops/reward-image/01k8x4dz25czry5hrtqa0nbp58.png\",\"name\":\"Team hJune Jacket\",\"organization_id\":\"01K6WKP5BBMPZJ89G5Y7QK1E9P\",\"required_units\":120}],\"rule\":{\"id\":1,\"name\":\"Watch to redeem\"},\"starts_at\":\"2025-11-13T21:00:00Z\",\"status\":\"active\",\"updated_at\":\"2025-11-05T16:48:56.579471Z\",\"url\":\"https://kick.facepunch.com\"},{\"category\":{\"id\":13,\"image_url\":\"https://files.kick.com/images/subcategories/13/banner/77786fd4-4f33-4221-b8ee-2bf3cb4d041e\",\"name\":\"Rust\",\"slug\":\"rust\"},\"channels\":[{\"banner_picture_url\":\"https://files.kick.com/images/channel/668/banner_image/6fcf7418-df00-460b-9467-1fa95b8eb981\",\"description\":\"THE BEST AT ABSOLUTELY EVERYTHING. THE JUICER. LEADER OF THE JUICERS.\",\"id\":668,\"slug\":\"xqc\",\"user\":{\"id\":676,\"profile_picture\":\"https://files.kick.com/images/user/676/profile_image/conversion/151f289a-5bff-4f31-b125-0c54c542519e-fullsize.webp\",\"username\":\"xQc\"}},{\"banner_picture_url\":\"https://files.kick.com/images/channel/168726/banner_image/8b6909c6-7598-4954-b33c-022fa519283f\",\"description\":\"\",\"id\":168726,\"slug\":\"mendo\",\"user\":{\"id\":170656,\"profile_picture\":\"https://files.kick.com/images/user/170656/profile_image/conversion/97d2cc46-fb92-46da-87f7-9c929bd56917-medium.webp\",\"username\":\"Mendo\"}}],\"connect_url\":\"https://kick.facepunch.com\",\"created_at\":\"2025-10-31T14:03:57.730297Z\",\"ends_at\":\"2025-11-23T23:59:00Z\",\"id\":\"01K8X9A2VJK0HQEST7FXVKY8EY\",\"name\":\"Team xQc Bow\",\"organization\":{\"id\":\"01K6WKP5BBMPZJ89G5Y7QK1E9P\",\"name\":\"Facepunch Studios\",\"url\":\"https://kick.facepunch.com\"},\"rewards\":[{\"category_id\":13,\"id\":\"01K8X4EKY4VJDXRMXEKJVK59NX\",\"image_url\":\"drops/reward-image/01k8x4eky4vjdxrmxekjvk59nx.png\",\"name\":\"Team xQc Bow\",\"organization_id\":\"01K6WKP5BBMPZJ89G5Y7QK1E9P\",\"required_units\":120}],\"rule\":{\"id\":1,\"name\":\"Watch to redeem\"},\"starts_at\":\"2025-11-13T21:00:00Z\",\"status\":\"active\",\"updated_at\":\"2025-11-11T20:40:23.176268Z\",\"url\":\"https://kick.facepunch.com\"},{\"category\":{\"id\":13,\"image_url\":\"https://files.kick.com/images/subcategories/13/banner/77786fd4-4f33-4221-b8ee-2bf3cb4d041e\",\"name\":\"Rust\",\"slug\":\"rust\"},\"channels\":[{\"banner_picture_url\":\"https://files.kick.com/images/channel/82500/banner_image/943c8b21-0cf6-4076-bace-0fd0cc876750\",\"description\":\"i am a gamer :D\",\"id\":82500,\"slug\":\"welyn\",\"user\":{\"id\":83389,\"profile_picture\":\"https://files.kick.com/images/user/83389/profile_image/conversion/3bc1af2d-1c88-4ce8-a9fe-24d3776b9dca-fullsize.webp\",\"username\":\"welyn\"}},{\"banner_picture_url\":\"https://files.kick.com/images/channel/229820/banner_image/default-banner-2.jpg\",\"description\":\"\",\"id\":229820,\"slug\":\"picco\",\"user\":{\"id\":232067,\"profile_picture\":\"https://files.kick.com/images/user/232067/profile_image/conversion/9a9250b4-12ac-486d-ba0e-277bdbd5562c-fullsize.webp\",\"username\":\"Picco\"}}],\"connect_url\":\"https://kick.facepunch.com\",\"created_at\":\"2025-10-31T14:05:27.800056Z\",\"ends_at\":\"2025-11-23T23:59:00Z\",\"id\":\"01K8X9CTTHAE9JSP2QCHE7F3HF\",\"name\":\"Team Welyn Fridge\",\"organization\":{\"id\":\"01K6WKP5BBMPZJ89G5Y7QK1E9P\",\"name\":\"Facepunch Studios\",\"url\":\"https://kick.facepunch.com\"},\"rewards\":[{\"category_id\":13,\"id\":\"01K8X4FFRP48SMH6N773K470ZH\",\"image_url\":\"drops/reward-image/01k8x4ffrp48smh6n773k470zh.png\",\"name\":\"Team Welyn Fridge\",\"organization_id\":\"01K6WKP5BBMPZJ89G5Y7QK1E9P\",\"required_units\":120}],\"rule\":{\"id\":1,\"name\":\"Watch to redeem\"},\"starts_at\":\"2025-11-13T21:00:00Z\",\"status\":\"active\",\"updated_at\":\"2025-11-06T23:40:20.049547Z\",\"url\":\"https://kick.facepunch.com\"},{\"category\":{\"id\":13,\"image_url\":\"https://files.kick.com/images/subcategories/13/banner/77786fd4-4f33-4221-b8ee-2bf3cb4d041e\",\"name\":\"Rust\",\"slug\":\"rust\"},\"channels\":[{\"banner_picture_url\":\"https://files.kick.com/images/channel/2410243/banner_image/bb570bc8-c991-4e83-b438-5878b1e3341b\",\"description\":\"\",\"id\":2410243,\"slug\":\"agustabell212\",\"user\":{\"id\":2465030,\"profile_picture\":\"https://files.kick.com/images/user/2465030/profile_image/conversion/61a61372-9269-4e46-9b6e-0661a8e43dd2-fullsize.webp\",\"username\":\"Agustabell212\"}},{\"banner_picture_url\":\"https://files.kick.com/images/channel/6357957/banner_image/default-banner-2.jpg\",\"description\":\"\",\"id\":6357957,\"slug\":\"panpots\",\"user\":{\"id\":6451243,\"profile_picture\":\"https://files.kick.com/images/user/6451243/profile_image/conversion/5f63340f-87aa-42bb-9488-4c676b3370ea-fullsize.webp\",\"username\":\"Panpots\"}}],\"connect_url\":\"https://kick.facepunch.com\",\"created_at\":\"2025-10-31T14:08:51.988837Z\",\"ends_at\":\"2025-11-23T23:59:00Z\",\"id\":\"01K8X9K277DKSD3KDVWPKJBK91\",\"name\":\"Team Panpots Bed\",\"organization\":{\"id\":\"01K6WKP5BBMPZJ89G5Y7QK1E9P\",\"name\":\"Facepunch Studios\",\"url\":\"https://kick.facepunch.com\"},\"rewards\":[{\"category_id\":13,\"id\":\"01K8X4G3Q2B2T1APAVXF1JRYT6\",\"image_url\":\"drops/reward-image/01k8x4g3q2b2t1apavxf1jryt6.png\",\"name\":\"Team Panpots Bed\",\"organization_id\":\"01K6WKP5BBMPZJ89G5Y7QK1E9P\",\"required_units\":120}],\"rule\":{\"id\":1,\"name\":\"Watch to redeem\"},\"starts_at\":\"2025-11-13T21:00:00Z\",\"status\":\"active\",\"updated_at\":\"2025-11-05T16:49:42.747559Z\",\"url\":\"https://kick.facepunch.com\"},{\"category\":{\"id\":13,\"image_url\":\"https://files.kick.com/images/subcategories/13/banner/77786fd4-4f33-4221-b8ee-2bf3cb4d041e\",\"name\":\"Rust\",\"slug\":\"rust\"},\"channels\":[{\"banner_picture_url\":\"https://files.kick.com/images/channel/328084/banner_image/default-banner-2.jpg\",\"description\":\"Welcome to my Kick channel, I'll be streaming here very soon :)\",\"id\":328084,\"slug\":\"blazed\",\"user\":{\"id\":336347,\"profile_picture\":\"https://files.kick.com/images/user/336347/profile_image/conversion/9e3b42c4-6de5-49f8-b610-51f6cd711991-fullsize.webp\",\"username\":\"Blazed\"}},{\"banner_picture_url\":\"\",\"description\":\"\",\"id\":74469958,\"slug\":\"spoonkid\",\"user\":{\"id\":75645462,\"profile_picture\":\"https://files.kick.com/images/user/75645462/profile_image/conversion/808affcf-d12f-43cd-8ec9-135ef932c575-medium.webp\",\"username\":\"spoonkid\"}}],\"connect_url\":\"https://kick.facepunch.com\",\"created_at\":\"2025-10-31T14:11:47.550066Z\",\"ends_at\":\"2025-11-23T23:59:00Z\",\"id\":\"01K8X9RDMMRYQYQ7XW9MMN1QAK\",\"name\":\"Team Spoonkid Door\",\"organization\":{\"id\":\"01K6WKP5BBMPZJ89G5Y7QK1E9P\",\"name\":\"Facepunch Studios\",\"url\":\"https://kick.facepunch.com\"},\"rewards\":[{\"category_id\":13,\"id\":\"01K8X4GW6QNTW3V2ARF9R6WFPD\",\"image_url\":\"drops/reward-image/01k8x4gw6qntw3v2arf9r6wfpd.png\",\"name\":\"Team Spoonkid Door\",\"organization_id\":\"01K6WKP5BBMPZJ89G5Y7QK1E9P\",\"required_units\":120}],\"rule\":{\"id\":1,\"name\":\"Watch to redeem\"},\"starts_at\":\"2025-11-13T21:00:00Z\",\"status\":\"active\",\"updated_at\":\"2025-11-05T16:48:16.981023Z\",\"url\":\"https://kick.facepunch.com\"},{\"category\":{\"id\":13,\"image_url\":\"https://files.kick.com/images/subcategories/13/banner/77786fd4-4f33-4221-b8ee-2bf3cb4d041e\",\"name\":\"Rust\",\"slug\":\"rust\"},\"channels\":[{\"banner_picture_url\":\"https://files.kick.com/images/channel/52304/banner_image/ae5b36f8-7ec6-4574-809d-24dc17548796\",\"description\":\"SOLO RUST RAT WITH TOO MANY HOURS\",\"id\":52304,\"slug\":\"qaixx\",\"user\":{\"id\":52733,\"profile_picture\":\"https://files.kick.com/images/user/52733/profile_image/conversion/9fabd57e-bcfa-4c66-9158-7f89456e8a37-fullsize.webp\",\"username\":\"qaixx\"}},{\"banner_picture_url\":\"https://files.kick.com/images/channel/109579/banner_image/default-banner-2.jpg\",\"description\":\"\",\"id\":109579,\"slug\":\"oilrats\",\"user\":{\"id\":110840,\"profile_picture\":\"https://files.kick.com/images/user/110840/profile_image/conversion/f75a787a-b8a9-4226-8ee1-88302ebb1381-fullsize.webp\",\"username\":\"oilrats\"}}],\"connect_url\":\"https://kick.facepunch.com\",\"created_at\":\"2025-10-31T14:13:56.813267Z\",\"ends_at\":\"2025-11-23T23:59:00Z\",\"id\":\"01K8X9WBWTN6CVHTPAB7F7F9DW\",\"name\":\"Team Oilrats Shotgun\",\"organization\":{\"id\":\"01K6WKP5BBMPZJ89G5Y7QK1E9P\",\"name\":\"Facepunch Studios\",\"url\":\"https://kick.facepunch.com\"},\"rewards\":[{\"category_id\":13,\"id\":\"01K8X4HX2S6XFE2ZMB4JBEQQEV\",\"image_url\":\"drops/reward-image/01k8x4hx2s6xfe2zmb4jbeqqev.png\",\"name\":\"Team Oilrats Shotgun\",\"organization_id\":\"01K6WKP5BBMPZJ89G5Y7QK1E9P\",\"required_units\":120}],\"rule\":{\"id\":1,\"name\":\"Watch to redeem\"},\"starts_at\":\"2025-11-13T21:00:00Z\",\"status\":\"active\",\"updated_at\":\"2025-11-05T16:47:46.083607Z\",\"url\":\"https://kick.facepunch.com\"}],\"message\":\"Success\"}";


            if (string.IsNullOrWhiteSpace(json) || json == "null")
                return Array.Empty<DropsCampaign>().AsReadOnly();

            JsonDocument doc = JsonDocument.Parse(json);
            if (!doc.RootElement.TryGetProperty("data", out JsonElement dataArray) || dataArray.ValueKind != JsonValueKind.Array)
                return Array.Empty<DropsCampaign>().AsReadOnly();

            List<DropsCampaign> campaigns = new List<DropsCampaign>();

            foreach (JsonElement camp in dataArray.EnumerateArray())
            {
                if (!camp.TryGetProperty("status", out JsonElement status) || status.GetString() != "active")
                    continue;

                JsonElement category = camp.GetProperty("category");

                DropsReward[] rewards = camp.GetProperty("rewards")
                    .EnumerateArray()
                    .Select(r => new DropsReward(
                        Id: r.GetProperty("id").GetString()!,
                        Name: r.GetProperty("name").GetString()!,
                        ImageUrl: "https://files.kick.com/" + r.GetProperty("image_url").GetString(),
                        RequiredMinutes: r.GetProperty("required_units").GetInt32()
                    ))
                    .ToArray();

                if (rewards.Length == 0) continue;

                // ALL CHANNELS — FULL REDUNDANCY
                List<string> connectUrls = new List<string>();

                if (camp.TryGetProperty("channels", out JsonElement channels) && channels.GetArrayLength() > 0)
                {
                    foreach (JsonElement channel in channels.EnumerateArray())
                    {
                        string? username = channel.TryGetProperty("slug", out JsonElement slug)
                            ? slug.GetString()
                            : channel.GetProperty("user").GetProperty("username").GetString();

                        if (!string.IsNullOrEmpty(username))
                            connectUrls.Add($"https://kick.com/{username.ToLowerInvariant()}");
                    }
                }

                // General drops = watch ANYONE in category
                if (connectUrls.Count == 0)
                {
                    string slug = category.GetProperty("slug").GetString()!;
                    connectUrls.Add($"https://kick.com/category/{slug}");
                }

                // Remove duplicates + sort by preference (optional)
                connectUrls = connectUrls.Distinct().ToList();

                campaigns.Add(new DropsCampaign(
                    Id: camp.GetProperty("id").GetString()!,
                    Name: camp.GetProperty("name").GetString()!,
                    GameName: category.GetProperty("name").GetString()!,
                    GameImageUrl: "https://files.kick.com/" + category.GetProperty("image_url").GetString(),
                    StartsAt: DateTimeOffset.Parse(camp.GetProperty("starts_at").GetString()!),
                    EndsAt: DateTimeOffset.Parse(camp.GetProperty("ends_at").GetString()!),
                    Rewards: rewards,
                    Platform: Platform,
                    ConnectUrls: connectUrls.AsReadOnly()
                ));
            }

            Debug.WriteLine($"[Kick Drops] Loaded {campaigns.Count} campaigns with full channel redundancy");
            return campaigns.AsReadOnly();
        }
    }
}